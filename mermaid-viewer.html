<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid 图表查看器</title>
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Mermaid CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        /* 自定义滚动条样式 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Mermaid 图表容器样式 */
        #mermaid-output {
            min-height: 200px;
        }
        
        /* 加载动画 */
        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- 页面标题 -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Mermaid 图表查看器</h1>
            <p class="text-gray-600">粘贴 Markdown 格式的 Mermaid 代码，实时预览图表效果</p>
        </div>
        
        <!-- 主要内容区域 -->
        <!-- 图表预览区域 - 全宽度，高度为一屏的80% -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-800">图表预览</h2>
                <button id="download-btn" class="px-3 py-1 text-sm bg-purple-600 hover:bg-purple-700 text-white rounded-md transition-colors duration-200 hidden">
                    下载 SVG
                </button>
            </div>
            
            <!-- 图表输出区域 -->
            <div 
                id="mermaid-output" 
                class="w-full border border-gray-300 rounded-lg p-4 overflow-auto custom-scrollbar bg-gray-50 flex items-center justify-center"
                style="height: 80vh;"
            >
                <div class="text-center text-gray-500">
                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <p class="text-lg font-medium">图表将在这里显示</p>
                    <p class="text-sm mt-1">请在下方输入 Mermaid 代码并点击渲染</p>
                </div>
            </div>
            
            <!-- 错误信息显示 -->
            <div id="error-message" class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg hidden">
                <p class="text-sm text-red-800">
                    <strong>错误：</strong><span id="error-text"></span>
                </p>
            </div>
        </div>
        
        <!-- 代码输入区域 - 全宽度，高度自适应 -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Mermaid 代码输入</h2>
                <button id="clear-btn" class="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-md transition-colors duration-200">
                    清空
                </button>
            </div>
            
            <!-- 文本输入框 -->
            <textarea 
                id="mermaid-input" 
                class="w-full p-4 border border-gray-300 rounded-lg resize-y focus:ring-2 focus:ring-blue-500 focus:border-transparent custom-scrollbar font-mono text-sm"
                style="min-height: 200px; height: auto;"
                placeholder="请粘贴 Mermaid 代码，例如：&#10;&#10;```mermaid&#10;graph TD&#10;    A[开始] --> B{判断条件}&#10;    B -->|是| C[执行操作]&#10;    B -->|否| D[结束]&#10;    C --> D&#10;```&#10;&#10;或者直接输入：&#10;&#10;graph TD&#10;    A[开始] --> B{判断条件}&#10;    B -->|是| C[执行操作]&#10;    B -->|否| D[结束]&#10;    C --> D"
            ></textarea>
            
            <!-- 操作按钮 -->
            <div class="flex gap-3 mt-4">
                <button 
                    id="render-btn" 
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                >
                    <span id="render-text">渲染图表</span>
                    <span id="loading-text" class="hidden">渲染中...</span>
                </button>
                
                <button 
                    id="example-btn" 
                    class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
                >
                    示例
                </button>
            </div>
            
            <!-- 提示信息 -->
            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm text-blue-800">
                    <strong>提示：</strong>支持粘贴包含 ```mermaid 代码块的 Markdown 文本，或直接输入 Mermaid 代码
                </p>
            </div>
        </div>
        
        <!-- 底部说明 -->
        <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">支持的图表类型</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div class="flex items-center">
                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                    <span>流程图 (Flowchart)</span>
                </div>
                <div class="flex items-center">
                    <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                    <span>时序图 (Sequence)</span>
                </div>
                <div class="flex items-center">
                    <span class="w-2 h-2 bg-purple-500 rounded-full mr-2"></span>
                    <span>甘特图 (Gantt)</span>
                </div>
                <div class="flex items-center">
                    <span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span>
                    <span>类图 (Class)</span>
                </div>
                <div class="flex items-center">
                    <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                    <span>状态图 (State)</span>
                </div>
                <div class="flex items-center">
                    <span class="w-2 h-2 bg-indigo-500 rounded-full mr-2"></span>
                    <span>饼图 (Pie)</span>
                </div>
                <div class="flex items-center">
                    <span class="w-2 h-2 bg-pink-500 rounded-full mr-2"></span>
                    <span>用户旅程 (Journey)</span>
                </div>
                <div class="flex items-center">
                    <span class="w-2 h-2 bg-gray-500 rounded-full mr-2"></span>
                    <span>Git 图 (GitGraph)</span>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 初始化 Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose',
            fontFamily: 'Arial, sans-serif'
        });
        
        // 获取 DOM 元素
        const inputTextarea = document.getElementById('mermaid-input');
        const outputDiv = document.getElementById('mermaid-output');
        const renderBtn = document.getElementById('render-btn');
        const clearBtn = document.getElementById('clear-btn');
        const exampleBtn = document.getElementById('example-btn');
        const downloadBtn = document.getElementById('download-btn');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const renderText = document.getElementById('render-text');
        const loadingText = document.getElementById('loading-text');
        
        // 示例 Mermaid 代码
        const exampleCode = `graph TD
    A[项目开始] --> B{需求分析}
    B -->|需求明确| C[系统设计]
    B -->|需求不明确| D[重新调研]
    D --> B
    C --> E[编码实现]
    E --> F[测试验证]
    F --> G{测试通过?}
    G -->|是| H[项目上线]
    G -->|否| I[修复问题]
    I --> F
    H --> J[项目结束]
    
    style A fill:#e1f5fe
    style H fill:#c8e6c9
    style J fill:#ffcdd2`;
        
        // 提取 Mermaid 代码的函数
        function extractMermaidCode(text) {
            // 移除前后空白
            text = text.trim();
            
            // 检查是否包含 ```mermaid 代码块
            const mermaidBlockRegex = /```mermaid\s*\n([\s\S]*?)\n```/g;
            const match = mermaidBlockRegex.exec(text);
            
            if (match) {
                return match[1].trim();
            }
            
            // 如果没有找到代码块，假设整个文本就是 Mermaid 代码
            return text;
        }
        
        // 显示错误信息
        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }
        
        // 隐藏错误信息
        function hideError() {
            errorMessage.classList.add('hidden');
        }
        
        // 设置加载状态
        function setLoading(loading) {
            if (loading) {
                renderText.classList.add('hidden');
                loadingText.classList.remove('hidden');
                renderBtn.disabled = true;
                renderBtn.classList.add('loading');
            } else {
                renderText.classList.remove('hidden');
                loadingText.classList.add('hidden');
                renderBtn.disabled = false;
                renderBtn.classList.remove('loading');
            }
        }
        
        // 渲染 Mermaid 图表
        async function renderMermaid() {
            const inputText = inputTextarea.value.trim();
            
            if (!inputText) {
                showError('请输入 Mermaid 代码');
                return;
            }
            
            hideError();
            setLoading(true);
            
            try {
                // 提取 Mermaid 代码
                const mermaidCode = extractMermaidCode(inputText);
                
                if (!mermaidCode) {
                    throw new Error('未找到有效的 Mermaid 代码');
                }
                
                // 清空输出区域
                outputDiv.innerHTML = '';
                
                // 创建一个临时的 div 来渲染图表
                const tempDiv = document.createElement('div');
                tempDiv.id = 'mermaid-temp-' + Date.now();
                outputDiv.appendChild(tempDiv);
                
                // 渲染图表
                const { svg } = await mermaid.render(tempDiv.id, mermaidCode);
                
                // 显示渲染结果
                outputDiv.innerHTML = svg;
                
                // 显示下载按钮
                downloadBtn.classList.remove('hidden');
                
                // 存储 SVG 内容用于下载
                downloadBtn.setAttribute('data-svg', svg);
                
            } catch (error) {
                console.error('Mermaid 渲染错误:', error);
                showError('图表渲染失败: ' + error.message);
                
                // 恢复默认显示
                outputDiv.innerHTML = `
                    <div class="text-center text-gray-500">
                        <svg class="w-16 h-16 mx-auto mb-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-lg font-medium text-red-600">渲染失败</p>
                        <p class="text-sm mt-1">请检查 Mermaid 代码语法</p>
                    </div>
                `;
                
                downloadBtn.classList.add('hidden');
            } finally {
                setLoading(false);
            }
        }
        
        // 下载 SVG 文件
        function downloadSVG() {
            const svgContent = downloadBtn.getAttribute('data-svg');
            if (!svgContent) return;
            
            const blob = new Blob([svgContent], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mermaid-chart.svg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
        }
        
        // 清空输入
        function clearInput() {
            inputTextarea.value = '';
            outputDiv.innerHTML = `
                <div class="text-center text-gray-500">
                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <p class="text-lg font-medium">图表将在这里显示</p>
                    <p class="text-sm mt-1">请在左侧输入 Mermaid 代码并点击渲染</p>
                </div>
            `;
            hideError();
            downloadBtn.classList.add('hidden');
            inputTextarea.focus();
        }
        
        // 加载示例
        function loadExample() {
            inputTextarea.value = exampleCode;
            inputTextarea.focus();
        }
        
        // 事件监听器
        renderBtn.addEventListener('click', renderMermaid);
        clearBtn.addEventListener('click', clearInput);
        exampleBtn.addEventListener('click', loadExample);
        downloadBtn.addEventListener('click', downloadSVG);
        
        // 键盘快捷键
        inputTextarea.addEventListener('keydown', function(e) {
            // Ctrl+Enter 或 Cmd+Enter 渲染图表
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                renderMermaid();
            }
        });
        
        // 页面加载完成后聚焦到输入框
        window.addEventListener('load', function() {
            inputTextarea.focus();
        });
    </script>
</body>
</html>